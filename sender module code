/*
 * ESP32 - Flex Sensor Reader & WiFi Sender
 * 
 * This code reads 4 flex sensors and sends data wirelessly to ESP8266
 * 
 * FLEX SENSORS (with 10kÎ© pull-down resistors):
 *   Flex 1 -> GPIO 36 (VP)
 *   Flex 2 -> GPIO 39 (VN)
 *   Flex 3 -> GPIO 34
 *   Flex 4 -> GPIO 35
 * 
 * NO WIRES NEEDED TO ESP8266!
 */

#include <WiFi.h>
#include <WiFiUdp.h>

// WiFi credentials - CHANGE THESE TO YOUR NETWORK
const char* ssid = "~Sarkar-House-AirFiber";        // Change this
const char* password = "zeCath0ua7vo8eem"; // Change this

// ESP8266 IP address - will be shown on OLED, update after first run
IPAddress esp8266IP(192, 168, 31, 115); // Default, change after seeing ESP8266's IP
const int udpPort = 4210;

WiFiUDP udp;

// Define flex sensor pins
#define FLEX1_PIN 36
#define FLEX2_PIN 39
#define FLEX3_PIN 34
#define FLEX4_PIN 35

// Sensor values
int flex1Value = 0;
int flex2Value = 0;
int flex3Value = 0;
int flex4Value = 0;

// Calibration thresholds
#define FLEX1_THRESHOLD 485
#define FLEX2_THRESHOLD 450
#define FLEX3_THRESHOLD 450
#define FLEX4_THRESHOLD 479

// Smoothing
const int numReadings = 10;
int readings1[numReadings];
int readings2[numReadings];
int readings3[numReadings];
int readings4[numReadings];
int readIndex = 0;
int total1 = 0, total2 = 0, total3 = 0, total4 = 0;

// Messages
String message1 = "I want to eat food";
String message2 = "I want to drink water";
String message3 = "I need help";
String message4 = "I am feeling cold";

void setup() {
  Serial.begin(115200);
  delay(1000);
  
  Serial.println("\n=== ESP32 Flex Sensor WiFi Sender ===");
  
  // Configure ADC
  analogReadResolution(10);
  analogSetAttenuation(ADC_11db);
  
  // Initialize smoothing arrays
  for (int i = 0; i < numReadings; i++) {
    readings1[i] = 0;
    readings2[i] = 0;
    readings3[i] = 0;
    readings4[i] = 0;
  }
  
  // Connect to WiFi
  Serial.print("Connecting to WiFi: ");
  Serial.println(ssid);
  WiFi.begin(ssid, password);
  
  int attempts = 0;
  while (WiFi.status() != WL_CONNECTED && attempts < 20) {
    delay(500);
    Serial.print(".");
    attempts++;
  }
  
  if (WiFi.status() == WL_CONNECTED) {
    Serial.println("\nWiFi connected!");
    Serial.print("ESP32 IP address: ");
    Serial.println(WiFi.localIP());
    Serial.print("Sending data to ESP8266 at: ");
    Serial.println(esp8266IP);
  } else {
    Serial.println("\nWiFi connection failed!");
    Serial.println("Check your WiFi credentials!");
  }
  
  udp.begin(udpPort);
  Serial.println("UDP started");
  Serial.println();
}

void loop() {
  // Subtract old readings
  total1 -= readings1[readIndex];
  total2 -= readings2[readIndex];
  total3 -= readings3[readIndex];
  total4 -= readings4[readIndex];
  
  // Read new values
  readings1[readIndex] = analogRead(FLEX1_PIN);
  readings2[readIndex] = analogRead(FLEX2_PIN);
  readings3[readIndex] = analogRead(FLEX3_PIN);
  readings4[readIndex] = analogRead(FLEX4_PIN);
  
  // Add new readings
  total1 += readings1[readIndex];
  total2 += readings2[readIndex];
  total3 += readings3[readIndex];
  total4 += readings4[readIndex];
  
  // Move to next position
  readIndex = (readIndex + 1) % numReadings;
  
  // Calculate averages
  flex1Value = total1 / numReadings;
  flex2Value = total2 / numReadings;
  flex3Value = total3 / numReadings;
  flex4Value = total4 / numReadings;
  
  // Determine message
  String currentMessage = "IDLE";
  
  if (flex1Value < FLEX1_THRESHOLD) {
    currentMessage = message1;
  } else if (flex2Value < FLEX2_THRESHOLD) {
    currentMessage = message2;
  } else if (flex3Value < FLEX3_THRESHOLD) {
    currentMessage = message3;
  } else if (flex4Value < FLEX4_THRESHOLD) {
    currentMessage = message4;
  }
  
  // Send data via WiFi (UDP)
  if (WiFi.status() == WL_CONNECTED) {
    String data = "F1:" + String(flex1Value) + 
                  ",F2:" + String(flex2Value) + 
                  ",F3:" + String(flex3Value) + 
                  ",F4:" + String(flex4Value) + 
                  ",MSG:" + currentMessage;
    
    udp.beginPacket(esp8266IP, udpPort);
    udp.print(data);
    udp.endPacket();
    
    // Debug output
    Serial.print("Sent: ");
    Serial.println(data);
  } else {
    Serial.println("WiFi disconnected!");
  }
  
  delay(500);
}
